name: Railway Scheduler

on:
  schedule:
    - cron: "*/15 * * * *"   # cada 15 min (cron en UTC)
  workflow_dispatch: {}

jobs:
  scheduler:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
      TIMEZONE: Europe/Madrid
      BUSINESS_START: "10:00"
      BUSINESS_END: "19:00"

    steps:
      - name: Instalar Railway CLI
        run: npm install -g @railway/cli

      - name: Alternar estado del servicio según horario
        run: |
          set -euo pipefail
          export TZ="$TIMEZONE"

          current_day=$(date +%u)    # 1=Lunes, 7=Domingo
          current_time=$(date +%H:%M)

          echo "🕐 Hora actual: $(date '+%Y-%m-%d %H:%M %Z')"
          echo "📅 Día de la semana: $current_day (1=Lunes, 7=Domingo)"
          echo "⏰ Hora actual: $current_time"
          echo "📝 Horario de negocio: $BUSINESS_START - $BUSINESS_END"

          if [ "$current_day" -ge 1 ] && [ "$current_day" -le 5 ] && \
             [[ "$current_time" > "$BUSINESS_START" ]] && [[ "$current_time" < "$BUSINESS_END" ]]; then
            echo "✅ Dentro de horario laboral, reanudando servicio..."
            railway service $RAILWAY_SERVICE_ID resume
          else
            echo "🚫 Fuera de horario laboral, pausando servicio..."
            railway service $RAILWAY_SERVICE_ID pause
          fi
