name: Railway Scheduler

on:
  schedule:
    - cron: "*/15 * * * *"   # cada 15 min (cron en UTC)
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Modo de prueba (no modifica Railway)'
        required: false
        default: false
        type: boolean

jobs:
  scheduler:
    # Si tu rama principal no es main, cambia esta condición
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
      TIMEZONE: Europe/Madrid
      BUSINESS_START: "10:00"
      BUSINESS_END: "19:00"
    steps:
      - name: Alternar estado del servicio en Railway según horario
        shell: bash
        run: |
          set -euo pipefail
          
          # Verificar secretos
          if [ -z "${RAILWAY_TOKEN:-}" ] || [ -z "${RAILWAY_SERVICE_ID:-}" ]; then
            echo "❌ Error: Faltan secretos RAILWAY_TOKEN o RAILWAY_SERVICE_ID"
            exit 1
          fi

          # Configurar timezone
          export TZ="$TIMEZONE"
          
          # Obtener información de tiempo actual
          current_day=$(date +%u)  # 1=Lunes, 7=Domingo
          current_hour=$(date +%H | sed 's/^0*//')  # Remover ceros iniciales
          current_minute=$(date +%M | sed 's/^0*//')  # Remover ceros iniciales
          
          # Manejar casos especiales (hora 00 -> 0)
          current_hour=${current_hour:-0}
          current_minute=${current_minute:-0}
          
          # Calcular minutos totales desde medianoche
          current_minutes=$((current_hour * 60 + current_minute))
          
          # Parsear horarios de negocio
          start_hour=$(echo "$BUSINESS_START" | cut -d: -f1 | sed 's/^0*//')
          start_minute=$(echo "$BUSINESS_START" | cut -d: -f2 | sed 's/^0*//')
          end_hour=$(echo "$BUSINESS_END" | cut -d: -f1 | sed 's/^0*//')
          end_minute=$(echo "$BUSINESS_END" | cut -d: -f2 | sed 's/^0*//')
          
          # Manejar casos especiales
          start_hour=${start_hour:-0}
          start_minute=${start_minute:-0}
          end_hour=${end_hour:-0}
          end_minute=${end_minute:-0}
          
          start_minutes=$((start_hour * 60 + start_minute))
          end_minutes=$((end_hour * 60 + end_minute))

          # Información de debug
          echo "🕐 Hora actual: $(date '+%Y-%m-%d %H:%M %Z')"
          echo "📅 Día de la semana: $current_day (1=Lunes, 7=Domingo)"
          echo "⏰ Minutos actuales: $current_minutes"
          echo "📝 Horario de negocio: $start_minutes - $end_minutes minutos"

          # Determinar si debe estar activo
          if [ "$current_day" -ge 1 ] && [ "$current_day" -le 5 ] && \
             [ "$current_minutes" -ge "$start_minutes" ] && [ "$current_minutes" -le "$end_minutes" ]; then
            pause=false
            echo "✅ Dentro de horario (${BUSINESS_START}-${BUSINESS_END}, L-V). Reanudando servicio."
          else
            pause=true
            echo "🚫 Fuera de horario. Poniendo servicio en pausa."
          fi

          # Preparar JSON para GraphQL
          json=$(cat <<EOF
          {
            "query": "mutation { serviceUpdate(id: \"$RAILWAY_SERVICE_ID\", pause: $pause) { id } }"
          }
          EOF
          )

          # Verificar si es modo de prueba
          if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            echo "🧪 MODO DE PRUEBA - No se enviará request a Railway"
            echo "📡 JSON que se enviaría:"
            echo "$json"
            echo "✅ Prueba completada exitosamente"
            exit 0
          fi

          echo "📡 Enviando request a Railway..."
          echo "🔑 Token: ${RAILWAY_TOKEN:0:10}..." # Solo mostrar primeros 10 caracteres
          echo "🆔 Service ID: $RAILWAY_SERVICE_ID"
          echo "📦 JSON: $json"
          
          # Verificar conectividad con Railway primero
          echo "🔍 Verificando conectividad con Railway..."
          health_check=$(curl -s -o /dev/null -w "%{http_code}" https://backboard.railway.app/graphql/v2)
          if [ "$health_check" != "200" ] && [ "$health_check" != "405" ]; then
            echo "❌ Error de conectividad con Railway: HTTP $health_check"
            exit 1
          fi
          echo "✅ Conectividad con Railway verificada"
          
          # Verificar que el token sea válido
          echo "🔐 Verificando validez del token..."
          token_check=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query": "query { viewer { id } }"}')
          
          if echo "$token_check" | grep -q '"errors"'; then
            echo "❌ Token inválido o expirado"
            echo "🔍 Respuesta del check: $token_check"
            exit 1
          fi
          echo "✅ Token válido"
          
          # Verificar que el service ID sea válido
          echo "🆔 Verificando service ID..."
          service_check=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"query { service(id: \\\"$RAILWAY_SERVICE_ID\\\") { id name } }\"}")
          
          if echo "$service_check" | grep -q '"errors"'; then
            echo "❌ Service ID inválido o sin permisos"
            echo "🔍 Respuesta del check: $service_check"
            exit 1
          fi
          echo "✅ Service ID válido"
          
          # Hacer llamada a Railway API con más debugging
          echo "🌐 URL: https://backboard.railway.app/graphql/v2"
          
          # Intentar con curl verbose para más información
          resp=$(curl -v -sS -w "HTTP_CODE:%{http_code}" -X POST https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHub-Action-Railway-Scheduler/1.0" \
            -d "$json" 2>&1)

          # Separar respuesta y código HTTP
          http_code=$(echo "$resp" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
          response_body=$(echo "$resp" | sed 's/HTTP_CODE:[0-9]*$//' | sed '/^[><*]/d') # Remover líneas de curl verbose

          echo "📋 Respuesta HTTP: $http_code"
          echo "📄 Respuesta completa: $response_body"
          
          # Verificar código HTTP
          if [ "$http_code" != "200" ]; then
            echo "❌ Error HTTP: $http_code"
            echo "🔍 Headers de respuesta:"
            echo "$resp" | grep -E "^< HTTP|^< [A-Za-z-]+:"
            exit 1
          fi
          
          # Verificar errores en GraphQL
          if echo "$response_body" | grep -q '"errors"'; then
            echo "❌ Error en Railway GraphQL:"
            echo "$response_body" | grep -o '"errors":\[[^]]*\]'
            
            # Intentar obtener más detalles del error
            echo "🔍 Detalles del error:"
            echo "$response_body" | jq -r '.errors[] | "Message: \(.message), Code: \(.code // "N/A"), Extensions: \(.extensions // "N/A")"' 2>/dev/null || echo "No se pudo parsear JSON de error"
            
            # Verificar si es un problema de autenticación
            if echo "$response_body" | grep -q "unauthorized\|authentication\|token"; then
              echo "🔐 Error de autenticación detectado. Verificar RAILWAY_TOKEN"
            fi
            
            # Verificar si es un problema de permisos
            if echo "$response_body" | grep -q "permission\|forbidden\|access"; then
              echo "🚫 Error de permisos detectado. Verificar permisos del token"
            fi
            
            exit 1
          fi
          
          echo "✅ Operación completada exitosamente"
