name: Railway Diagnostic

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'AcciÃ³n a realizar'
        required: true
        default: 'diagnose'
        type: choice
        options:
          - diagnose
          - test-token
          - test-service
          - test-mutation

jobs:
  diagnostic:
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
    steps:
      - name: DiagnÃ³stico de Railway
        shell: bash
        run: |
          set -euo pipefail
          
          echo "ğŸ” DIAGNÃ“STICO DE RAILWAY"
          echo "=========================="
          
          # Verificar secretos
          if [ -z "${RAILWAY_TOKEN:-}" ]; then
            echo "âŒ RAILWAY_TOKEN no estÃ¡ configurado"
            exit 1
          fi
          
          if [ -z "${RAILWAY_SERVICE_ID:-}" ]; then
            echo "âŒ RAILWAY_SERVICE_ID no estÃ¡ configurado"
            exit 1
          fi
          
          echo "âœ… Secretos configurados"
          echo "ğŸ”‘ Token: ${RAILWAY_TOKEN:0:10}..."
          echo "ğŸ†” Service ID: $RAILWAY_SERVICE_ID"
          
          # Verificar conectividad bÃ¡sica
          echo ""
          echo "ğŸŒ Verificando conectividad..."
          if curl -s -f https://backboard.railway.app/graphql/v2 > /dev/null; then
            echo "âœ… Conectividad con Railway OK"
          else
            echo "âŒ No se puede conectar con Railway"
            exit 1
          fi
          
          # Verificar token
          echo ""
          echo "ğŸ” Verificando token..."
          token_response=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query": "query { viewer { id email } }"}')
          
          if echo "$token_response" | grep -q '"errors"'; then
            echo "âŒ Token invÃ¡lido o expirado"
            echo "ğŸ” Error: $token_response"
          else
            echo "âœ… Token vÃ¡lido"
            viewer_id=$(echo "$token_response" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
            echo "ğŸ‘¤ Viewer ID: $viewer_id"
          fi
          
          # Verificar service
          echo ""
          echo "ğŸ†” Verificando service..."
          service_response=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"query { service(id: \\\"$RAILWAY_SERVICE_ID\\\") { id name status } }\"}")
          
          if echo "$service_response" | grep -q '"errors"'; then
            echo "âŒ Service ID invÃ¡lido o sin permisos"
            echo "ğŸ” Error: $service_response"
          else
            echo "âœ… Service ID vÃ¡lido"
            service_name=$(echo "$service_response" | grep -o '"name":"[^"]*"' | cut -d'"' -f4)
            service_status=$(echo "$service_response" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
            echo "ğŸ“‹ Service: $service_name"
            echo "ğŸ“Š Status: $service_status"
          fi
          
          # Probar mutation (solo lectura)
          echo ""
          echo "ğŸ§ª Probando mutation (solo lectura)..."
          mutation_response=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"mutation { serviceUpdate(id: \\\"$RAILWAY_SERVICE_ID\\\", pause: false) { id } }\"}")
          
          if echo "$mutation_response" | grep -q '"errors"'; then
            echo "âŒ Mutation fallÃ³"
            echo "ğŸ” Error: $mutation_response"
          else
            echo "âœ… Mutation exitosa"
            echo "ğŸ” Respuesta: $mutation_response"
          fi
          
          echo ""
          echo "ğŸ DiagnÃ³stico completado"
